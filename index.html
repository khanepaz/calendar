<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقویم سالانه شمسی — بهینه شده</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        * {
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px 10px;
            font-family: 'Vazirmatn', IRANSans, Tahoma, sans-serif;
            min-height: 100vh;
            animation: gradientShift 8s ease-in-out infinite alternate;
        }
        @keyframes gradientShift {
            0% { background: linear-gradient(135deg, #667eea, #764ba2); }
            50% { background: linear-gradient(135deg, #f093fb, #f5576c); }
            100% { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        }
        .container {
            max-width: 1400px;
        }
        /* تم‌های فصلی */
        .season-spring {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf, #dcedc1);
            box-shadow: 0 15px 35px rgba(86, 171, 47, 0.3);
        }
        .season-summer {
            background: linear-gradient(135deg, #f7931e, #ffd89b, #19547b);
            box-shadow: 0 15px 35px rgba(247, 147, 30, 0.3);
        }
        .season-autumn {
            background: linear-gradient(135deg, #d2691e, #cd853f, #daa520);
            box-shadow: 0 15px 35px rgba(210, 105, 30, 0.3);
        }
        .season-winter {
            background: linear-gradient(135deg, #74b9ff, #0984e3, #636e72);
            box-shadow: 0 15px 35px rgba(116, 185, 255, 0.3);
        }
        .season-title {
            background: rgba(255,255,255,0.95);
            padding: 20px 30px;
            border-radius: 25px;
            font-weight: 700;
            margin: 30px 0 25px;
            color: #2d3436;
            text-align: center;
            backdrop-filter: blur(20px);
            border: 3px solid rgba(255,255,255,0.3);
            font-size: 1.8rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transform: translateY(0);
            transition: all 0.3s ease;
        }
        .season-title:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .season-title::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        .month-card {
            background: rgba(255,255,255,0.95);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 25px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
        }
        .month-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 200% 100%;
            animation: gradientMove 3s ease-in-out infinite;
        }
        @keyframes gradientMove {
            0%, 100% { background-position: 0% 0%; }
            50% { background-position: 100% 0%; }
        }
        .month-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        /* تم‌های ماهانه */
        .month-card.spring {
            border-top: 5px solid #56ab2f;
            background: linear-gradient(145deg, rgba(255,255,255,0.98), rgba(168, 230, 207, 0.1));
        }
        .month-card.summer {
            border-top: 5px solid #f7931e;
            background: linear-gradient(145deg, rgba(255,255,255,0.98), rgba(255, 216, 155, 0.1));
        }
        .month-card.autumn {
            border-top: 5px solid #d2691e;
            background: linear-gradient(145deg, rgba(255,255,255,0.98), rgba(218, 165, 32, 0.1));
        }
        .month-card.winter {
            border-top: 5px solid #74b9ff;
            background: linear-gradient(145deg, rgba(255,255,255,0.98), rgba(116, 185, 255, 0.1));
        }
        .month-header {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2d3436;
            text-align: center;
            padding: 15px 0;
            border-bottom: 3px solid rgba(108, 92, 231, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .toggle-events-btn {
            font-size: 0.85rem;
            padding: 8px 16px;
            border-radius: 20px;
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            border: none;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }
        .toggle-events-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
            background: linear-gradient(45deg, #5f3dc4, #9775fa);
        }
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        .weekday-label {
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            color: #636e72;
            padding: 10px 0;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .day-cell {
            min-height: 55px;
            border: 2px solid transparent;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-weight: 500;
            font-size: 1rem;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .day-cell:hover {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: #6c5ce7;
            z-index: 2;
        }
        .day-cell.today {
            border: 3px solid #6c5ce7;
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            color: white;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6); }
            100% { box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        }
        .day-cell.holiday {
            color: #e74c3c;
            font-weight: bold;
            background: linear-gradient(135deg, #fff5f5, #fed7e2);
        }
        .day-cell.holiday:hover {
            background: linear-gradient(135deg, #fed7e2, #fbb6ce);
        }
        .day-cell.other-month {
            opacity: 0.4;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #adb5bd;
        }
        /* نشانه ستاره برای مناسبت‌های کاربری */
        .day-cell.has-user-event::after {
            content: '★';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 12px;
            color: #f39c12;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            animation: starTwinkle 2s infinite;
            z-index: 3;
        }
        @keyframes starTwinkle {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.2);
            }
        }
        .day-cell.has-user-event:hover::after {
            animation: starBounce 0.6s ease-in-out;
        }
        @keyframes starBounce {
            0%, 100% { transform: scale(1.2); }
            50% { transform: scale(1.5); }
        }
        /* مناسبت‌های ماه */
        .month-events-container {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e3f2fd);
            border-radius: 16px;
            display: none;
            max-height: 250px;
            overflow-y: auto;
            border: 2px solid rgba(108, 92, 231, 0.1);
        }
        .month-events-container::-webkit-scrollbar {
            width: 6px;
        }
        .month-events-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
        }
        .month-events-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            border-radius: 3px;
        }
        .event-item {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-size: 0.9rem;
            border-left: 4px solid #6c5ce7;
            transition: all 0.3s ease;
        }
        .event-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
        }
        .event-day {
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 5px;
        }
        .event-text {
            color: #636e72;
            line-height: 1.5;
        }
        .event-text.user-event {
            color: #e17055;
            font-weight: 500;
        }
        /* مودال‌ها */
        .modal-content {
            border-radius: 24px;
            padding: 30px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3436;
            text-align: center;
        }
        .form-control {
            font-size: 1rem;
            padding: 15px;
            border-radius: 16px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.8);
        }
        .form-control:focus {
            border-color: #6c5ce7;
            box-shadow: 0 0 0 0.2rem rgba(108, 92, 231, 0.15);
            background: white;
        }
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            border: none;
            padding: 12px 30px;
            border-radius: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 92, 231, 0.4);
            background: linear-gradient(135deg, #5f3dc4, #9775fa);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #636e72, #b2bec3);
            border: none;
            padding: 12px 30px;
            border-radius: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #2d3436, #636e72);
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: none;
            padding: 12px 30px;
            border-radius: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #c0392b, #a93226);
        }
        .btn-outline-primary {
            padding: 8px 20px;
            font-size: 0.9rem;
            border-radius: 20px;
            border: 2px solid #6c5ce7;
            color: #6c5ce7;
            transition: all 0.3s ease;
        }
        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            transform: translateY(-2px);
        }
        .alarm-modal .modal-content {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 3px solid #f39c12;
        }
        .alarm-modal .modal-title {
            color: #e67e22;
        }
        .loading-month {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 24px;
            z-index: 10;
            font-size: 1rem;
            color: #6c5ce7;
            font-weight: 500;
            backdrop-filter: blur(5px);
        }
        /* انیمیشن بارگذاری */
        .loading-month::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #6c5ce7;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* سال و عنوان اصلی */
        h1 {
            font-size: 3rem;
            font-weight: 700;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }
        @keyframes titleGlow {
            0% { text-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.5); }
            100% { text-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 30px rgba(255,255,255,0.8); }
        }
        .year-selector {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        #year-input {
            border-radius: 12px;
            border: 2px solid #e9ecef;
            padding: 10px 15px;
            font-weight: 500;
        }
        #year-input:focus {
            border-color: #6c5ce7;
            box-shadow: 0 0 0 0.2rem rgba(108, 92, 231, 0.15);
        }
        /* موبایل */
        @media (max-width: 767.98px) {
            .day-cell {
                min-height: 50px;
                font-size: 0.9rem;
            }
            .month-header {
                flex-direction: column;
                gap: 15px;
                font-size: 1.2rem;
            }
            .month-events-container {
                max-height: 200px;
                font-size: 0.85rem;
                padding: 15px;
            }
            h1 {
                font-size: 2.2rem;
            }
            .season-title {
                font-size: 1.4rem;
                padding: 15px 20px;
            }
            .modal-content {
                padding: 20px;
            }
        }
        @media (max-width: 575.98px) {
            .days-grid {
                gap: 4px;
            }
            .day-cell {
                min-height: 45px;
                font-size: 0.85rem;
            }
            .weekday-label {
                font-size: 0.75rem;
                padding: 8px 0;
            }
        }
        /* ایفکت‌های اضافی */
        .floating {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        /* Tooltip سفارشی */
        .tooltip {
            font-family: 'Vazirmatn', sans-serif;
        }
        .tooltip-inner {
            background: linear-gradient(135deg, #2d3436, #636e72);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 0.85rem;
            max-width: 200px;
        }
        .tooltip.bs-tooltip-top .tooltip-arrow::before {
            border-top-color: #2d3436;
        }
    </style>
</head>
<body>
    <div class="fluid-container">
        <h1 class="text-center text-white my-4 floating">📅 تقویم سالانه شمسی</h1>
        <div class="text-center mb-4">
            <div class="year-selector">
                <label for="year-input" class="form-label text-dark mb-3" style="font-size: 1.1rem; font-weight: 600;">انتخاب سال:</label>
                <div>
                    <input type="number" id="year-input" value="1404" min="1300" max="1500" class="form-control d-inline-block w-auto mx-2" style="width: 120px!important;">
                    <button onclick="changeYear()" class="btn btn-primary">نمایش تقویم</button>
                </div>
            </div>
        </div>
        <div id="calendar-content">
            <div class="text-center text-white py-5">
                <div class="loading-month" style="position: relative; background: rgba(255,255,255,0.1); color: white;">
                    در حال بارگذاری تقویم...
                </div>
            </div>
        </div>
    </div>
<!-- مودال افزودن/ویرایش مناسبت -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <h5 class="modal-title" id="eventModalLabel">✨ مدیریت مناسبت شخصی</h5>
            <p id="modalDateDisplay" class="text-muted text-center"></p>
            <input type="hidden" id="editingEventId"> <!-- برای ذخیره ID مناسبت در حال ویرایش -->
            <textarea id="eventInput" class="form-control my-3" placeholder="متن مناسبت خود را وارد کنید..."></textarea>
            <div class="d-flex justify-content-between gap-3">
                <button type="button" class="btn btn-danger flex-fill" id="deleteEventBtn" style="display: none;" onclick="deleteEvent()">🗑️ حذف</button>
                <button type="button" class="btn btn-secondary flex-fill" onclick="closeModal()">انصراف</button>
                <button type="button" class="btn btn-primary flex-fill" onclick="saveEvent()">💾 ذخیره</button>
            </div>
        </div>
    </div>
</div>
    <!-- مودال آلارم -->
    <div class="modal fade alarm-modal" id="alarmModal" tabindex="-1" aria-labelledby="alarmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <h5 class="modal-title" id="alarmModalLabel">🔔 یادآوری مناسبت فردا!</h5>
                <p id="alarmMessage" class="my-4"></p>
                <button type="button" class="btn btn-warning w-100" onclick="closeAlarmModal()">متوجه شدم 👍</button>
            </div>
        </div>
    </div>
    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const persianMonths = [
            "فروردین", "اردیبهشت", "خرداد",     // بهار
            "تیر", "مرداد", "شهریور",           // تابستان
            "مهر", "آبان", "آذر",               // پاییز
            "دی", "بهمن", "اسفند"               // زمستان
        ];
        const seasonThemes = {
            spring: ['فروردین', 'اردیبهشت', 'خرداد'],
            summer: ['تیر', 'مرداد', 'شهریور'],
            autumn: ['مهر', 'آبان', 'آذر'],
            winter: ['دی', 'بهمن', 'اسفند']
        };
        let currentYear = 1404;
        let userEvents = JSON.parse(localStorage.getItem('userEvents') || '{}');
        let apiCache = JSON.parse(localStorage.getItem('apiCache') || '{}');
        let selectedDateForEvent = null;
        let monthEventsCache = {};
        const calendarContent = document.getElementById('calendar-content');
        const yearInput = document.getElementById('year-input');
        const eventInput = document.getElementById('eventInput');
        const modalDateDisplay = document.getElementById('modalDateDisplay');
        const alarmMessage = document.getElementById('alarmMessage');

        // تابع تولید شناسه منحصر به فرد
        function generateEventId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // تعیین تم فصل برای ماه
        function getSeasonTheme(monthName) {
            for (const [season, months] of Object.entries(seasonThemes)) {
                if (months.includes(monthName)) {
                    return season;
                }
            }
            return 'spring';
        }

        // =============================
        // 🧠 کش مناسب برای API
        // =============================
        async function getApiData(year, month, day) {
            const key = `${year}-${month}-${day}`;
            const cacheKey = `api_${key}`;
            const now = Date.now();
            const cacheExpiry = 7 * 24 * 60 * 60 * 1000; // 7 روز
            // اگر در کش بود و تازه بود، برگردون
            if (apiCache[cacheKey] && (now - apiCache[cacheKey].timestamp < cacheExpiry)) {
                return apiCache[cacheKey].data;
            }
            // در غیر این صورت، از API بگیر
            try {
                const url = `https://pnldev.com/api/calender?year=${year}&month=${month}&day=${day}&holiday=true`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.status && data.result) {
                    // ذخیره در کش
                    apiCache[cacheKey] = {
                        data: data.result,
                        timestamp: now
                    };
                    localStorage.setItem('apiCache', JSON.stringify(apiCache));
                    return data.result;
                }
            } catch (error) {
                console.warn("Failed to fetch from API for", key);
            }
            return null;
        }

        // =============================
        // 🧩 توابع اصلی
        // =============================
        async function renderYearCalendar(year) {
            currentYear = year;
            calendarContent.innerHTML = '';
            const seasons = [
                { title: "🌸 فصل بهار", months: [1, 2, 3], class: 'season-spring' },
                { title: "☀️ فصل تابستان", months: [4, 5, 6], class: 'season-summer' },
                { title: "🍂 فصل پاییز", months: [7, 8, 9], class: 'season-autumn' },
                { title: "❄️ فصل زمستان", months: [10, 11, 12], class: 'season-winter' }
            ];
            for (const season of seasons) {
                const seasonDiv = document.createElement('div');
                seasonDiv.className = `season-section mb-5 ${season.class}`;
                seasonDiv.style.borderRadius = '30px';
                seasonDiv.style.padding = '30px';
                seasonDiv.style.marginBottom = '40px';
                seasonDiv.innerHTML = `<h3 class="season-title">${season.title}</h3>`;
                const row = document.createElement('div');
                row.className = 'row';
                for (const month of season.months) {
                    const col = document.createElement('div');
                    col.className = 'col-12 col-md-6 col-lg-4 mb-4';
                    const monthTheme = getSeasonTheme(persianMonths[month - 1]);
                    const monthCard = document.createElement('div');
                    monthCard.className = `month-card ${monthTheme}`;
                    monthCard.innerHTML = `
                        <div class="month-header">
                            <span>${persianMonths[month - 1]} ${year}</span>
                            <button class="toggle-events-btn" onclick="toggleMonthEvents(${year}, ${month})">
                                📋 مناسبت‌ها
                            </button>
                        </div>
                        <div class="days-grid" id="grid-${year}-${month}">
                            <div class="weekday-label">ش</div>
                            <div class="weekday-label">ی</div>
                            <div class="weekday-label">د</div>
                            <div class="weekday-label">س</div>
                            <div class="weekday-label">چ</div>
                            <div class="weekday-label">پ</div>
                            <div class="weekday-label">ج</div>
                        </div>
                        <div class="loading-month" id="loading-${year}-${month}" style="display:none;">
                            در حال بارگذاری...
                        </div>
                        <div class="month-events-container" id="events-${year}-${month}"></div>
                    `;
                    col.appendChild(monthCard);
                    row.appendChild(col);
                }
                seasonDiv.appendChild(row);
                calendarContent.appendChild(seasonDiv);
                // رندر ماه‌ها به صورت موازی (همزمان)
                season.months.forEach(month => {
                    renderMonth(year, month);
                });
            }
            checkAlarmForTomorrow();
        }

        async function renderMonth(year, month) {
    const grid = document.getElementById(`grid-${year}-${month}`);
    const loading = document.getElementById(`loading-${year}-${month}`);
    if (!grid || !loading) return;
    loading.style.display = 'flex';
    try {
        // دریافت اولین روز ماه
        const firstDayData = await getDayOfWeek(year, month, 1);
        let startDay = convertToNumericDay(firstDayData.dayWeek);
        const totalDays = daysInMonth(year, month);

        // پاک کردن روزهای قبلی
        const existingDays = grid.querySelectorAll('.day-cell');
        existingDays.forEach(d => d.remove());

        // روزهای ماه قبل
        const prevMonth = month === 1 ? 12 : month - 1;
        const prevYear = month === 1 ? year - 1 : year;
        const prevMonthTotalDays = daysInMonth(prevYear, prevMonth);
        for (let i = 0; i < startDay; i++) {
            const dayNum = prevMonthTotalDays - startDay + i + 1;
            const dayCell = createDayCell(dayNum, prevYear, prevMonth, true, []);
            grid.appendChild(dayCell);
        }

        // روزهای ماه جاری — ✅ فقط یک بار داده‌ها رو می‌گیریم
        const monthEvents = [];
        const dayCells = [];

        for (let day = 1; day <= totalDays; day++) {
            // داده‌های روز رو از کش یا API می‌گیریم
            const apiData = await getApiData(year, month, day);
            const events = [];

            // مناسبت‌های کاربری — 🚨 بخش اصلاح شده 🚨
            const userKey = `${year}-${month}-${day}`;
            let hasUserEvent = false;

            if (userEvents[userKey]) {
                // اصلاح: مستقیماً روی آرایه اصلی کار می‌کنیم و ID را اگر نبود اضافه می‌کنیم
                userEvents[userKey] = userEvents[userKey].map(e => {
                    if (!e.id) {
                        e.id = generateEventId(); // ایجاد و ذخیره دائمی ID
                        localStorage.setItem('userEvents', JSON.stringify(userEvents)); // ذخیره فوری تغییرات
                    }
                    hasUserEvent = true;
                    return e;
                });

                // حالا داده‌های اصلاح شده را به آرایه events اضافه می‌کنیم
                userEvents[userKey].forEach(e => {
                    events.push({
                        id: e.id, // حالا مطمئنیم ID وجود دارد
                        text: e.text,
                        isHoliday: false,
                        isUser: true
                    });
                });
            }

            // مناسبت‌های رسمی
            if (apiData && apiData.event && Array.isArray(apiData.event)) {
                apiData.event.forEach(e => {
                    events.push({
                        text: e,
                        isHoliday: true,
                        isUser: false
                    });
                });
            }

            // ذخیره برای نمایش لیست ماه
            if (events.length > 0) {
                monthEvents.push({ day, events });
            }

            const dayCell = createDayCell(day, year, month, false, events, hasUserEvent);
            dayCells.push(dayCell);
        }

        // اضافه کردن روزها به گرید
        dayCells.forEach(cell => grid.appendChild(cell));

        // روزهای ماه بعد
        const remainingCells = 42 - (startDay + totalDays);
        const nextMonth = month === 12 ? 1 : month + 1;
        const nextYear = month === 12 ? year + 1 : year;
        for (let i = 1; i <= remainingCells; i++) {
            const dayCell = createDayCell(i, nextYear, nextMonth, true, []);
            grid.appendChild(dayCell);
        }

        // ذخیره مناسبت‌های ماه برای نمایش بعدی
        monthEventsCache[`${year}-${month}`] = monthEvents;

        // هایلایت امروز
        highlightTodayInMonth(year, month);

        // رندر لیست مناسبت‌ها (اگر قبلاً باز شده بود)
        renderMonthEventsList(year, month);

    } catch (error) {
        console.error("Error rendering month:", error);
    } finally {
        loading.style.display = 'none';
    }
}


        // 🆕 ساخت سلول روز — با نشانه ستاره برای مناسبت‌های کاربری
        function createDayCell(day, year, month, isOtherMonth, events, hasUserEvent = false) {
            const dayCell = document.createElement('div');
            dayCell.classList.add('day-cell');
            if (isOtherMonth) dayCell.classList.add('other-month');
            dayCell.textContent = day;
            const key = `${year}-${month}-${day}`;
            // اگر تعطیل یا مناسبت داره، کلاس holiday
            if (events.some(e => e.isHoliday)) {
                dayCell.classList.add('holiday');
            }
            // اگر مناسبت کاربری داره، کلاس has-user-event اضافه کن
            if (hasUserEvent) {
                dayCell.classList.add('has-user-event');
            }
            dayCell.dataset.date = key;
            // افزودن Tooltip با Bootstrap
            if (events.length > 0) {
                const tooltipText = events.map(e => e.text).join('\n');
                dayCell.setAttribute('data-bs-toggle', 'tooltip');
                dayCell.setAttribute('data-bs-placement', 'top');
                dayCell.setAttribute('title', tooltipText);
                new bootstrap.Tooltip(dayCell);
            }
            if (!isOtherMonth) {
                dayCell.addEventListener('click', () => openEventModal(year, month, day));
            }
            return dayCell;
        }

        // نمایش/مخفی کردن لیست مناسبت‌های ماه
        function toggleMonthEvents(year, month) {
            const container = document.getElementById(`events-${year}-${month}`);
            if (!container) return;
            if (container.style.display === 'block') {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
                renderMonthEventsList(year, month);
            }
        }

        // رندر لیست مناسبت‌های ماه
        function renderMonthEventsList(year, month) {
            const container = document.getElementById(`events-${year}-${month}`);
            if (!container) return;
            const events = monthEventsCache[`${year}-${month}`] || [];
            if (events.length === 0) {
                container.innerHTML = '<p class="text-center text-muted my-3">📅 مناسبتی برای این ماه ثبت نشده است.</p>';
                return;
            }
            let html = '<h6 class="mb-3 text-center" style="color: #2d3436; font-weight: 600;">🎯 مناسبت‌های این ماه:</h6>';
            events.forEach(item => {
                item.events.forEach(event => {
                    const eventIcon = event.isUser ? '⭐' : '🎉';
                    const eventClass = event.isUser ? 'user-event' : '';
                    html += `
                        <div class="event-item">
                            <div class="event-day">${eventIcon} روز ${item.day} ${persianMonths[month - 1]}</div>
                            <div class="event-text ${eventClass}">${event.text}</div>
                            ${event.isUser ? `
                            <div class="mt-2 d-flex justify-content-end gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="editEventFromList(${year}, ${month}, ${item.day}, '${event.id}')">✏️ ویرایش</button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteEventFromList('${year}-${month}-${item.day}', '${event.id}', ${year}, ${month})">🗑️ حذف</button>
                            </div>` : ''}
                        </div>
                    `;
                });
            });
            container.innerHTML = html;
        }

        // =============================
        // 🧰 توابع کمکی
        // =============================
        function convertToNumericDay(persianDay) {
            const days = { 'ش': 0, 'ی': 1, 'د': 2, 'س': 3, 'چ': 4, 'پ': 5, 'ج': 6 };
            return days[persianDay] || 0;
        }

        function daysInMonth(year, month) {
            if (month <= 6) return 31;
            if (month <= 11) return 30;
            return isLeapYear(year) ? 30 : 29;
        }

        function isLeapYear(year) {
            const base = year - 1343;
            return (base % 33 === 1 || base % 33 === 5 || base % 33 === 9 ||
                    base % 33 === 13 || base % 33 === 17 || base % 33 === 22 ||
                    base % 33 === 26 || base % 33 === 30);
        }

        async function getDayOfWeek(year, month, day) {
            const cacheKey = `dow_${year}-${month}-${day}`;
            const now = Date.now();
            const cacheExpiry = 30 * 24 * 60 * 60 * 1000; // 30 روز
            if (apiCache[cacheKey] && (now - apiCache[cacheKey].timestamp < cacheExpiry)) {
                return apiCache[cacheKey].data.solar;
            }
            try {
                const url = `https://pnldev.com/api/calender?year=${year}&month=${month}&day=${day}&holiday=false`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.status && data.result && data.result.solar) {
                    apiCache[cacheKey] = {
                        data: data.result,
                        timestamp: now
                    };
                    localStorage.setItem('apiCache', JSON.stringify(apiCache));
                    return data.result.solar;
                }
            } catch (e) {
                console.warn("API failed, using fallback for day of week");
            }
            return { dayWeek: calculateDayOfWeekFallback(year, month, day) };
        }

        function calculateDayOfWeekFallback(y, m, d) {
            const days = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];
            let totalDays = 0;
            for (let year = 1300; year < y; year++) {
                totalDays += isLeapYear(year) ? 366 : 365;
            }
            for (let month = 1; month < m; month++) {
                totalDays += daysInMonth(y, month);
            }
            totalDays += d - 1;
            return days[totalDays % 7];
        }

        function highlightTodayInMonth(year, month) {
            const now = new Date();
            const jalali = gregorianToJalaliSimple(now.getFullYear(), now.getMonth() + 1, now.getDate());
            if (jalali.jy === year && jalali.jm === month) {
                const todayCell = document.querySelector(`.day-cell[data-date="${year}-${month}-${jalali.jd}"]:not(.other-month)`);
                if (todayCell) todayCell.classList.add('today');
            }
        }

        function gregorianToJalaliSimple(gy, gm, gd) {
            const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            let jy = (gy <= 1600) ? 0 : 979;
            gy -= (gy <= 1600) ? 621 : 1600;
            let gy2 = (gm > 2) ? (gy + 1) : gy;
            let days = (365 * gy) + Math.floor((gy2 + 3) / 4) - Math.floor((gy2 + 99) / 100) + Math.floor((gy2 + 399) / 400) - 80 + gd + g_d_m[gm - 1];
            jy += 33 * Math.floor(days / 12053);
            days %= 12053;
            jy += 4 * Math.floor(days / 1461);
            days %= 1461;
            if (days > 365) {
                jy += Math.floor((days - 1) / 365);
                days = (days - 1) % 365;
            }
            let jm = (days < 186) ? 1 + Math.floor(days / 31) : 7 + Math.floor((days - 186) / 30);
            let jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
            return { jy, jm, jd };
        }

        // =============================
        // 🎯 توابع کاربری (ویرایش و حذف اضافه شده)
        // =============================
        function openEventModal(year, month, day) {
    selectedDateForEvent = { year, month, day };
    modalDateDisplay.textContent = `📅 ${persianMonths[month - 1]} ${day}، ${year}`;
    eventInput.value = '';
    const deleteBtn = document.getElementById('deleteEventBtn');
    deleteBtn.style.display = 'none'; // به طور پیش‌فرض مخفی است
    document.getElementById('editingEventId').value = ''; // پاک کردن ID قبلی

    const key = `${year}-${month}-${day}`;
    const events = userEvents[key] || [];

    // اگر فقط یک مناسبت کاربری وجود دارد، آن را برای ویرایش آماده می‌کنیم
    if (events.length === 1) {
        const event = events[0];
        eventInput.value = event.text;
        document.getElementById('editingEventId').value = event.id || generateEventId(); // اگر ID نداشت، ایجاد می‌کنیم
        deleteBtn.style.display = 'block'; // دکمه حذف را نمایش می‌دهیم
    } else if (events.length > 1) {
        // اگر بیش از یک مناسبت وجود دارد، یک پیام نمایش می‌دهیم
        alert("این روز چندین مناسبت دارد. لطفاً از لیست ماه، مناسبت مورد نظر را ویرایش یا حذف کنید.");
    }

    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
    modal.show();
    setTimeout(() => eventInput.focus(), 300);
}

   
function deleteEvent() {
    if (!selectedDateForEvent) return;

    const { year, month, day } = selectedDateForEvent;
    const key = `${year}-${month}-${day}`;
    const editingEventId = document.getElementById('editingEventId').value;

    if (userEvents[key]) {
        userEvents[key] = userEvents[key].filter(e => e.id !== editingEventId);
        // اگر آرایه خالی شد، کلید را از localStorage حذف می‌کنیم
        if (userEvents[key].length === 0) {
            delete userEvents[key];
        }
        localStorage.setItem('userEvents', JSON.stringify(userEvents));
    }

    closeModal();
    renderMonth(year, month); // رفرش ماه جاری
}

        // ویرایش مناسبت از لیست ماه
        function editEventFromList(year, month, day, eventId) {
            selectedDateForEvent = { year, month, day };
            const key = `${year}-${month}-${day}`;
            const eventToEdit = userEvents[key].find(e => e.id === eventId);

            if (eventToEdit) {
                modalDateDisplay.textContent = `📅 ${persianMonths[month - 1]} ${day}، ${year}`;
                eventInput.value = eventToEdit.text;
                document.getElementById('editingEventId').value = eventId;
                document.getElementById('deleteEventBtn').style.display = 'block';

                const modal = new bootstrap.Modal(document.getElementById('eventModal'));
                modal.show();
                setTimeout(() => eventInput.focus(), 300);
            }
        }
        function saveEvent() {
    if (!selectedDateForEvent) return;
    const { year, month, day } = selectedDateForEvent;
    const text = eventInput.value.trim();
    if (!text) {
        alert('لطفاً متن مناسبت را وارد کنید.');
        return;
    }
    const key = `${year}-${month}-${day}`;
    const editingEventId = document.getElementById('editingEventId').value;

    if (!userEvents[key]) {
        userEvents[key] = [];
    }

    if (editingEventId) {
        // ویرایش مناسبت موجود
        const eventIndex = userEvents[key].findIndex(e => e.id === editingEventId);
        if (eventIndex !== -1) {
            userEvents[key][eventIndex].text = text;
        }
    } else {
        // افزودن مناسبت جدید
        const newEvent = {
            id: generateEventId(), // ایجاد ID جدید
            text: text
        };
        userEvents[key].push(newEvent);
    }

    localStorage.setItem('userEvents', JSON.stringify(userEvents));
    closeModal();
    renderMonth(year, month); // رفرش ماه جاری
}


        // حذف مناسبت از لیست ماه
        function deleteEventFromList(key, eventId, year, month) {
            if (confirm("آیا مطمئنید می‌خواهید این مناسبت را حذف کنید؟")) {
                if (userEvents[key]) {
                    userEvents[key] = userEvents[key].filter(e => e.id !== eventId);
                    if (userEvents[key].length === 0) {
                        delete userEvents[key];
                    }
                    localStorage.setItem('userEvents', JSON.stringify(userEvents));
                    renderMonthEventsList(year, month); // فقط لیست مناسبت‌ها را رفرش می‌کند
                }
            }
        }

        function closeModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
            if (modal) modal.hide();
            selectedDateForEvent = null;
        }

        function closeAlarmModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('alarmModal'));
            if (modal) modal.hide();
        }

        function checkAlarmForTomorrow() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(now.getDate() + 1);
            const jalali = gregorianToJalaliSimple(tomorrow.getFullYear(), tomorrow.getMonth() + 1, tomorrow.getDate());
            const key = `${jalali.jy}-${jalali.jm}-${jalali.jd}`;
            if (userEvents[key] && userEvents[key].length > 0) {
                const eventsText = userEvents[key].map(e => `⭐ ${e.text}`).join('<br>');
                alarmMessage.innerHTML = `
                    <div style="text-align: center; margin-bottom: 15px;">
                        فردا (${persianMonths[jalali.jm - 1]} ${jalali.jd}) مناسبت‌های زیر را دارید:
                    </div>
                    <div style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 12px; text-align: center;">
                        ${eventsText}
                    </div>
                `;
                const modal = new bootstrap.Modal(document.getElementById('alarmModal'));
                modal.show();
            }
        }

        function changeYear() {
            const year = parseInt(yearInput.value);
            if (isNaN(year) || year < 1300 || year > 1500) {
                alert('⚠️ لطفا سال معتبر (1300-1500) را وارد کنید.');
                return;
            }
            renderYearCalendar(year);
        }

        // فعال‌سازی Tooltip‌ها در کل صفحه
        document.addEventListener('DOMContentLoaded', () => {
            renderYearCalendar(currentYear);
            // بررسی یادآوری هر 5 دقیقه
            setInterval(checkAlarmForTomorrow, 300000);
            // فعال‌سازی tooltip‌ها برای عناصر جدید
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1 && node.hasAttribute && node.hasAttribute('data-bs-toggle')) {
                                new bootstrap.Tooltip(node, {
                                    html: false,
                                    delay: { show: 300, hide: 100 }
                                });
                            }
                        });
                    }
                });
            });
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
        <script>
            if ('serviceWorker' in navigator) {
              window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                  .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                  })
                  .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                  });
              });
            }
          </script>
</body>
</html>